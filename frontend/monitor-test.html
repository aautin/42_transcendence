<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring des Connexions Utilisateurs</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1 {
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .connection-form {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        input, button {
            padding: 8px;
            margin-right: 10px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #online-users {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 200px;
        }
        
        .user-item {
            background-color: #e9f5e9;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
        }
        
        .current-user {
            background-color: #d4edda;
            border-left: 4px solid #4CAF50;
            font-weight: bold;
        }
        
        #status {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f8f8;
            border-left: 4px solid #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .connected {
            color: green;
            font-weight: bold;
        }
        
        .disconnected {
            color: red;
            font-weight: bold;
        }
        
        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .indicator-green {
            background-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }
        
        .indicator-red {
            background-color: #f44336;
            box-shadow: 0 0 5px #f44336;
        }
        
        .indicator-yellow {
            background-color: #ff9800;
            box-shadow: 0 0 5px #ff9800;
        }
        
        .heartbeat {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        #event-log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            height: 150px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px;
            border-bottom: 1px dotted #ddd;
        }
        
        #current-user-status {
            margin-top: 15px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .connection-time {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .health-indicator {
            display: flex;
            align-items: center;
        }
        
        .ping-status {
            margin-left: 10px;
            font-size: 0.8em;
        }

        /* Styles pour la gestion multi-utilisateurs */
        .multi-user-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .user-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .user-tab {
            padding: 8px 15px;
            margin-right: 5px;
            margin-bottom: -1px;
            border: 1px solid #ddd;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            background-color: #f1f1f1;
        }
        
        .user-tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            font-weight: bold;
        }
        
        .user-tab-close {
            margin-left: 10px;
            font-weight: bold;
            color: #999;
        }
        
        .user-tab-close:hover {
            color: red;
        }
        
        /* Styles pour la barre de recherche */
        .search-container {
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .search-box {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .search-btn {
            margin-left: 10px;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            padding: 5px;
            background-color: white;
            display: none;
        }
        
        .result-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .result-item:hover {
            background-color: #f0f7ff;
        }
        
        .result-item .indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .result-item .online {
            background-color: #4CAF50;
        }
        
        .result-item .offline {
            background-color: #f44336;
        }
        
        /* Modal pour les détails de l'utilisateur recherché */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 70%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .user-details {
            padding: 15px;
            border-left: 4px solid #4CAF50;
            background-color: #f9f9f9;
        }
        
        /* Override des styles existants pour le multi-utilisateur */
        #current-user-status {
            margin-bottom: 15px;
        }

        /* Améliorations pour l'interface de recherche */
        .search-container {
            position: relative;
        }
        
        .search-results {
            position: absolute;
            width: calc(100% - 100px);
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .result-item {
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .result-status {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        /* Amélioration des badges de statut */
        .status-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
            color: white;
        }
        
        .badge-online {
            background-color: #4CAF50;
        }
        
        .badge-offline {
            background-color: #f44336;
        }
        
        /* Style pour les onglets utilisateur */
        .user-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .user-tab {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            background-color: #f1f1f1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-tab.active {
            background-color: #e0f2e0;
            border-color: #4CAF50;
            font-weight: bold;
        }
        
        .user-tab:hover {
            background-color: #e9e9e9;
        }
        
        .user-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .dot-green {
            background-color: #4CAF50;
        }
        
        .dot-red {
            background-color: #f44336;
        }
        
        .user-tab-close {
            margin-left: 8px;
            font-weight: bold;
            color: #999;
            padding: 0 5px;
        }
        
        .user-tab-close:hover {
            color: #f44336;
            background-color: rgba(0,0,0,0.05);
            border-radius: 50%;
        }
        
        /* Amélioration du style pour la section active */
        .session-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Monitoring des Connexions Utilisateurs</h1>
    
    <div class="connection-form">
        <h2>Simuler une connexion utilisateur</h2>
        <input type="text" id="username" placeholder="Nom d'utilisateur">
        <button id="connect-btn">Se Connecter</button>
        <button id="new-session-btn" title="Créer une nouvelle session">Nouvelle Session</button>
    </div>

    <!-- Section de recherche d'utilisateurs améliorée -->
    <div class="search-container">
        <input type="text" id="search-input" class="search-box" placeholder="Rechercher un utilisateur en ligne...">
        <button id="search-btn" class="search-btn">Rechercher</button>
        <div id="search-results" class="search-results"></div>
    </div>
    
    <!-- Modal pour afficher les détails d'un utilisateur recherché -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Détails de l'utilisateur</h2>
            <div id="user-details" class="user-details"></div>
            <div id="user-actions" style="margin-top: 15px; text-align: right;">
                <button id="refresh-user-btn">Rafraîchir le statut</button>
            </div>
        </div>
    </div>
    
    <h2>Utilisateurs en ligne</h2>
    <div id="online-users">
        <p>Aucun utilisateur connecté</p>
    </div>
    
    <!-- Container pour les sessions utilisateur -->
    <div class="multi-user-container">
        <h2>Sessions actives</h2>
        <div class="user-tabs" id="user-tabs">
            <!-- Les onglets seront ajoutés dynamiquement -->
        </div>
        
        <div id="active-session" class="session-container">
            <div id="status">
                <div>
                    Statut: <span id="connection-status" class="disconnected">Déconnecté</span>
                    <span id="connection-indicator" class="connection-indicator indicator-red"></span>
                </div>
                <div class="health-indicator">
                    <button id="ping-btn" disabled>Ping</button>
                    <span class="ping-status" id="ping-status"></span>
                </div>
            </div>
            
            <div id="current-user-status" style="display: none;">
                <h2>Votre Session</h2>
                <div>
                    <strong>Nom d'utilisateur:</strong> <span id="current-username">-</span>
                </div>
                <div>
                    <strong>ID:</strong> <span id="current-userid">-</span>
                </div>
                <div>
                    <strong>État:</strong> <span id="current-connection-state" class="connected">Connecté</span>
                    <span id="current-indicator" class="connection-indicator indicator-green heartbeat"></span>
                </div>
                <div class="connection-time">
                    Connecté depuis: <span id="connection-time">0 secondes</span>
                </div>
            </div>
            
            <div id="session-controls" style="display: none; margin-top: 15px;">
                <button id="disconnect-btn" disabled>Se Déconnecter</button>
            </div>
        </div>
    </div>
    
    <h2>Journal des événements</h2>
    <div id="event-log"></div>
    
    <script>
        // Configuration
        const WS_URL = 'ws://localhost:3000/ws';
        const PING_INTERVAL = 5000; // 5 secondes
        
        // Variables globales
        const sessions = new Map(); // Stocke toutes les sessions actives
        let activeSessionId = null; // Session actuellement affichée
        let allOnlineUsers = []; // Tous les utilisateurs en ligne
        
        // Éléments DOM principaux
        const usernameInput = document.getElementById('username');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const newSessionBtn = document.getElementById('new-session-btn');
        const pingBtn = document.getElementById('ping-btn');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');
        const userModal = document.getElementById('user-modal');
        const modalClose = document.querySelector('.modal-close');
        const userDetails = document.getElementById('user-details');
        const userTabs = document.getElementById('user-tabs');
        const onlineUsersList = document.getElementById('online-users');
        const eventLog = document.getElementById('event-log');
        
        // Éléments DOM de statut
        const connectionStatus = document.getElementById('connection-status');
        const connectionIndicator = document.getElementById('connection-indicator');
        const pingStatus = document.getElementById('ping-status');
        const currentUserStatus = document.getElementById('current-user-status');
        const sessionControls = document.getElementById('session-controls');
        const currentUserUsername = document.getElementById('current-username');
        const currentUserId_element = document.getElementById('current-userid');
        const currentConnectionState = document.getElementById('current-connection-state');
        const currentIndicator = document.getElementById('current-indicator');
        const connectionTime = document.getElementById('connection-time');
        
        // Classe Session pour gérer plusieurs connexions
        class UserSession {
            constructor(username) {
                this.id = Date.now().toString() + Math.random().toString(36).substr(2, 5); // ID unique
                this.username = username;
                this.userId = null; // sera défini lors de la connexion
                this.socket = null;
                this.isConnected = false;
                this.connectionStartTime = null;
                this.pingIntervalId = null;
                this.pingTimeoutId = null;
                this.lastPingTime = null;
                this.timeUpdateInterval = null;
                
                // Créer l'onglet pour cette session
                this.createTab();
            }
            
            createTab() {
                const tab = document.createElement('div');
                tab.className = 'user-tab';
                tab.dataset.sessionId = this.id;
                
                const statusDot = document.createElement('span');
                statusDot.className = 'user-dot ' + (this.isConnected ? 'dot-green' : 'dot-red');
                
                tab.appendChild(statusDot);
                tab.appendChild(document.createTextNode(this.username || 'Nouvelle session'));
                
                const closeBtn = document.createElement('span');
                closeBtn.className = 'user-tab-close';
                closeBtn.textContent = '×';
                closeBtn.dataset.sessionId = this.id;
                tab.appendChild(closeBtn);
                
                tab.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('user-tab-close')) {
                        switchToSession(this.id);
                    }
                });
                
                userTabs.appendChild(tab);
                return tab;
            }
            
            connect() {
                if (this.socket) {
                    this.socket.close();
                }
                
                addLogEntry(`Tentative de connexion en tant que ${this.username}...`);
                
                this.socket = new WebSocket(WS_URL);
                
                this.socket.onopen = () => {
                    addLogEntry(`[${this.username}] Connexion WebSocket établie`);
                    
                    // Générer un ID utilisateur pour la démo
                    this.userId = Math.floor(Math.random() * 1000000) + 1;
                    
                    // Envoyer les informations de connexion
                    this.socket.send(JSON.stringify({
                        type: 'connection',
                        userId: this.userId,
                        username: this.username
                    }));
                    
                    this.isConnected = true;
                    this.connectionStartTime = new Date();
                    this.updateUI();
                    
                    // Démarrer les pings périodiques
                    this.startPingInterval();
                };
                
                this.socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'online_users_update') {
                            allOnlineUsers = data.users;
                            updateOnlineUsers(allOnlineUsers);
                            
                            if (this.id === activeSessionId) {
                                addLogEntry(`[${this.username}] Mise à jour des utilisateurs en ligne: ${data.users.length} utilisateur(s)`);
                            }
                            
                            // Vérifier si l'utilisateur actuel est toujours dans la liste
                            const isUserStillConnected = data.users.some(user => user.id === this.userId);
                            
                            if (this.isConnected && !isUserStillConnected) {
                                if (this.id === activeSessionId) {
                                    addLogEntry(`[${this.username}] Attention: Vous n'apparaissez plus comme connecté côté serveur!`);
                                }
                                this.updateConnectionState(false);
                            }
                        } 
                        else if (data.type === 'pong' && data.timestamp) {
                            this.handlePong(data.timestamp);
                        }
                    } catch (error) {
                        console.error('Erreur lors du traitement du message:', error);
                    }
                };
                
                this.socket.onclose = (event) => {
                    let reason = '';
                    if (event.code) {
                        reason = ` (Code: ${event.code}` + (event.reason ? `, Raison: ${event.reason})` : ')';
                    }
                    
                    if (this.id === activeSessionId) {
                        addLogEntry(`[${this.username}] Connexion WebSocket fermée${reason}`);
                    }
                    
                    this.disconnect();
                };
                
                this.socket.onerror = (error) => {
                    if (this.id === activeSessionId) {
                        addLogEntry(`[${this.username}] Erreur WebSocket: ${error.message || 'Erreur inconnue'}`);
                    }
                    
                    this.updateConnectionState(false);
                };
            }
            
            disconnect() {
                this.stopPingInterval();
                this.isConnected = false;
                this.userId = null;
                this.connectionStartTime = null;
                
                if (this.timeUpdateInterval) {
                    clearInterval(this.timeUpdateInterval);
                    this.timeUpdateInterval = null;
                }
                
                if (this.socket) {
                    if (this.socket.readyState === WebSocket.OPEN) {
                        this.socket.close(1000, "Déconnexion manuelle");
                    }
                    this.socket = null;
                }
                
                this.updateUI();
            }
            
            updateUI() {
                if (this.id === activeSessionId) {
                    // Mettre à jour l'interface pour la session active
                    connectionStatus.textContent = this.isConnected ? 'Connecté' : 'Déconnecté';
                    connectionStatus.className = this.isConnected ? 'connected' : 'disconnected';
                    connectionIndicator.className = this.isConnected ? 
                        'connection-indicator indicator-green' : 
                        'connection-indicator indicator-red';
                    
                    disconnectBtn.disabled = !this.isConnected;
                    pingBtn.disabled = !this.isConnected;
                    
                    currentUserStatus.style.display = this.isConnected ? 'block' : 'none';
                    sessionControls.style.display = this.isConnected ? 'block' : 'none';
                    
                    if (this.isConnected) {
                        currentUserUsername.textContent = this.username;
                        currentUserId_element.textContent = this.userId;
                        
                        // Démarrer la mise à jour du temps de connexion
                        this.updateConnectionTime();
                    } else {
                        pingStatus.textContent = '';
                    }
                }
                
                // Mettre à jour l'onglet
                const tab = document.querySelector(`.user-tab[data-session-id="${this.id}"]`);
                if (tab) {
                    const statusDot = tab.querySelector('.user-dot');
                    if (statusDot) {
                        statusDot.className = 'user-dot ' + (this.isConnected ? 'dot-green' : 'dot-red');
                    }
                }
            }
            
            updateConnectionState(connected) {
                if (connected === undefined) {
                    connected = this.isConnected;
                }
                
                if (this.id === activeSessionId) {
                    currentConnectionState.textContent = connected ? 'Connecté' : 'Déconnecté côté serveur';
                    currentConnectionState.className = connected ? 'connected' : 'disconnected';
                    currentIndicator.className = connected ? 
                        'connection-indicator indicator-green heartbeat' : 
                        'connection-indicator indicator-red heartbeat';
                }
            }
            
            updateConnectionTime() {
                if (!this.connectionStartTime) return;
                
                const updateTime = () => {
                    const now = new Date();
                    const diffMs = now - this.connectionStartTime;
                    const diffSecs = Math.floor(diffMs / 1000);
                    
                    if (this.id === activeSessionId) {
                        if (diffSecs < 60) {
                            connectionTime.textContent = `${diffSecs} seconde(s)`;
                        } else if (diffSecs < 3600) {
                            connectionTime.textContent = `${Math.floor(diffSecs / 60)} minute(s) ${diffSecs % 60} seconde(s)`;
                        } else {
                            connectionTime.textContent = `${Math.floor(diffSecs / 3600)} heure(s) ${Math.floor((diffSecs % 3600) / 60)} minute(s)`;
                        }
                    }
                };
                
                updateTime();
                
                if (this.timeUpdateInterval) {
                    clearInterval(this.timeUpdateInterval);
                }
                
                this.timeUpdateInterval = setInterval(updateTime, 1000);
            }
            
            startPingInterval() {
                this.stopPingInterval();
                this.pingIntervalId = setInterval(() => this.sendPing(), PING_INTERVAL);
            }
            
            stopPingInterval() {
                if (this.pingIntervalId) {
                    clearInterval(this.pingIntervalId);
                    this.pingIntervalId = null;
                }
                
                if (this.pingTimeoutId) {
                    clearTimeout(this.pingTimeoutId);
                    this.pingTimeoutId = null;
                }
            }
            
            sendPing() {
                if (!this.socket || this.socket.readyState !== WebSocket.OPEN) return;
                
                this.lastPingTime = Date.now();
                this.socket.send(JSON.stringify({
                    type: 'ping',
                    userId: this.userId,
                    timestamp: this.lastPingTime
                }));
                
                // Définir un timeout pour détecter l'absence de pong
                if (this.pingTimeoutId) clearTimeout(this.pingTimeoutId);
                
                this.pingTimeoutId = setTimeout(() => {
                    if (this.id === activeSessionId) {
                        connectionIndicator.className = 'connection-indicator indicator-yellow';
                        currentIndicator.className = 'connection-indicator indicator-yellow heartbeat';
                        currentConnectionState.className = '';
                        currentConnectionState.textContent = 'Instable';
                        currentConnectionState.style.color = '#ff9800';
                        pingStatus.textContent = 'Timeout';
                        pingStatus.style.color = '#ff9800';
                        addLogEntry(`[${this.username}] Ping timeout - connexion instable`);
                    }
                }, 3000);
            }
            
            handlePong(timestamp) {
                if (!this.lastPingTime) return;
                
                const latency = Date.now() - this.lastPingTime;
                
                if (this.id === activeSessionId) {
                    pingStatus.textContent = `${latency}ms`;
                    pingStatus.style.color = latency > 300 ? '#ff9800' : '#4CAF50';
                    
                    // Réinitialiser le timeout
                    if (this.pingTimeoutId) {
                        clearTimeout(this.pingTimeoutId);
                        this.pingTimeoutId = null;
                    }
                    
                    // Mettre à jour l'indicateur comme étant connecté
                    connectionIndicator.className = 'connection-indicator indicator-green';
                    currentIndicator.className = 'connection-indicator indicator-green heartbeat';
                    currentConnectionState.className = 'connected';
                    currentConnectionState.textContent = 'Connecté';
                }
            }
        }
        
        // Fonctions pour la gestion des sessions multiples
        function createNewSession(username = '') {
            const session = new UserSession(username || 'Session ' + (sessions.size + 1));
            sessions.set(session.id, session);
            switchToSession(session.id);
            return session;
        }
        
        function switchToSession(sessionId) {
            if (!sessions.has(sessionId)) return;
            
            activeSessionId = sessionId;
            
            // Mettre à jour l'UI pour la nouvelle session active
            const activeSession = sessions.get(activeSessionId);
            activeSession.updateUI();
            
            // Mettre à jour les onglets
            document.querySelectorAll('.user-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.sessionId === sessionId);
            });
        }
        
        function removeSession(sessionId) {
            if (!sessions.has(sessionId)) return;
            
            const session = sessions.get(sessionId);
            session.disconnect();
            
            // Supprimer l'onglet
            const tab = document.querySelector(`.user-tab[data-session-id="${sessionId}"]`);
            if (tab) tab.remove();
            
            sessions.delete(sessionId);
            
            // Si c'était la session active, en activer une autre
            if (activeSessionId === sessionId) {
                const remainingSessions = Array.from(sessions.keys());
                if (remainingSessions.length > 0) {
                    switchToSession(remainingSessions[0]);
                } else {
                    // Créer une nouvelle session vide
                    createNewSession();
                }
            }
        }
        
        // Fonctions pour l'interface utilisateur
        function addLogEntry(message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            eventLog.appendChild(entry);
            eventLog.scrollTop = eventLog.scrollHeight;
        }
        
        function updateOnlineUsers(users) {
            onlineUsersList.innerHTML = '';
            
            if (!users || users.length === 0) {
                const noUsers = document.createElement('p');
                noUsers.textContent = 'Aucun utilisateur connecté';
                onlineUsersList.appendChild(noUsers);
                return;
            }
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                // Vérifier si cet utilisateur est dans l'une de nos sessions
                let isOurSession = false;
                let sessionId = null;
                
                sessions.forEach((session, id) => {
                    if (session.userId === user.id) {
                        isOurSession = true;
                        sessionId = id;
                    }
                });
                
                if (isOurSession) {
                    userItem.classList.add('current-user');
                }
                
                userItem.innerHTML = `
                    <span>${user.username} (ID: ${user.id})</span>
                    <span>
                        ${isOurSession ? 
                            `<strong>(Votre session: ${sessions.get(sessionId).username})</strong> <span class="connection-indicator indicator-green"></span>` : ''}
                    </span>
                `;
                
                // Ajouter un clic pour afficher les détails
                userItem.addEventListener('click', () => {
                    showUserDetails(user);
                });
                
                onlineUsersList.appendChild(userItem);
            });
        }
        
        // Fonction de recherche améliorée
        function searchUsers(query) {
            if (!query) {
                searchResults.style.display = 'none';
                return;
            }
            
            // Filtrer tous les utilisateurs en ligne
            const results = allOnlineUsers.filter(user => 
                user.username.toLowerCase().includes(query.toLowerCase()) || 
                user.id.toString().includes(query)
            );
            
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'result-item';
                noResults.textContent = 'Aucun utilisateur trouvé';
                searchResults.appendChild(noResults);
            } else {
                results.forEach(user => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    
                    // Vérifier si c'est l'un de nos utilisateurs
                    let isOurUser = false;
                    let sessionId = null;
                    
                    sessions.forEach((session, id) => {
                        if (session.userId === user.id) {
                            isOurUser = true;
                            sessionId = id;
                        }
                    });
                    
                    // Indicateur visuel amélioré
                    const statusClass = isOurUser ? 'badge-online' : 'badge-online';
                    const statusText = isOurUser ? 'Votre session' : 'En ligne';
                    
                    resultItem.innerHTML = `
                        <div>
                            <span class="indicator online"></span>
                            ${user.username} 
                            <span style="color: #666; font-size: 0.8em;">(ID: ${user.id})</span>
                        </div>
                        <div class="result-status">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    `;
                    
                    resultItem.addEventListener('click', () => {
                        showUserDetails(user);
                        searchResults.style.display = 'none';
                    });
                    
                    searchResults.appendChild(resultItem);
                });
            }
            
            searchResults.style.display = 'block';
        }
        
        // Fonction améliorée pour afficher les détails de l'utilisateur
        function showUserDetails(user) {
            // Vérifier si l'utilisateur est toujours connecté
            const isStillOnline = allOnlineUsers.some(u => u.id === user.id);
            const status = isStillOnline ? 'en ligne' : 'hors ligne';
            const statusClass = isStillOnline ? 'connected' : 'disconnected';
            
            // Trouver si c'est l'un de nos utilisateurs
            let isOurUser = false;
            let sessionId = null;
            
            sessions.forEach((session, id) => {
                if (session.userId === user.id) {
                    isOurUser = true;
                    sessionId = id;
                }
            });
            
            // Construire l'affichage détaillé
            userDetails.innerHTML = `
                <h3>${user.username}</h3>
                <p><strong>ID:</strong> ${user.id}</p>
                <p><strong>Statut:</strong> <span class="${statusClass}">${status}</span></p>
                ${isOurUser ? 
                    `<p><strong>Note:</strong> Cet utilisateur est l'une de vos sessions actives.</p>
                     <p><strong>Session:</strong> ${sessions.get(sessionId).username}</p>
                     <p><strong>Connecté depuis:</strong> ${getConnectionTime(sessions.get(sessionId).connectionStartTime)}</p>` 
                    : ''}
            `;
            
            // Ajouter un bouton pour passer à cette session si c'est l'une des nôtres
            if (isOurUser) {
                const switchButton = document.createElement('button');
                switchButton.textContent = 'Afficher cette session';
                switchButton.addEventListener('click', () => {
                    switchToSession(sessionId);
                    userModal.style.display = 'none';
                });
                userDetails.appendChild(switchButton);
            }
            
            userModal.style.display = 'block';
            
            // Configurer le bouton de rafraîchissement
            const refreshButton = document.getElementById('refresh-user-btn');
            refreshButton.onclick = () => {
                showUserDetails(user);
                addLogEntry(`Statut de ${user.username} rafraîchi`);
            };
        }
        
        // Fonction pour formater le temps de connexion
        function getConnectionTime(startTime) {
            if (!startTime) return "Non connecté";
            
            const now = new Date();
            const diffMs = now - startTime;
            const diffSecs = Math.floor(diffMs / 1000);
            
            if (diffSecs < 60) {
                return `${diffSecs} seconde(s)`;
            } else if (diffSecs < 3600) {
                return `${Math.floor(diffSecs / 60)} minute(s) ${diffSecs % 60} seconde(s)`;
            } else {
                return `${Math.floor(diffSecs / 3600)} heure(s) ${Math.floor((diffSecs % 3600) / 60)} minute(s)`;
            }
        }
        
        // Amélioration de l'UI des sessions
        function createNewSession(username = '') {
            const session = new UserSession(username || 'Session ' + (sessions.size + 1));
            sessions.set(session.id, session);
            switchToSession(session.id);
            return session;
        }
        
        // Event Listeners
        window.addEventListener('DOMContentLoaded', () => {
            // Créer une session vide au démarrage
            createNewSession();
            
            // Événements pour les boutons principaux
            connectBtn.addEventListener('click', function() {
                const username = usernameInput.value.trim();
                if (username) {
                    // Vérifier si une session avec ce nom existe déjà
                    let existingSession = null;
                    sessions.forEach(session => {
                        if (session.username === username && !session.isConnected) {
                            existingSession = session;
                        }
                    });
                    
                    if (existingSession) {
                        // Réutiliser la session existante
                        switchToSession(existingSession.id);
                        existingSession.connect();
                    } else {
                        // Créer une nouvelle session
                        const session = createNewSession(username);
                        session.connect();
                    }
                } else {
                    alert('Veuillez entrer un nom d\'utilisateur');
                }
            });
            
            newSessionBtn.addEventListener('click', function() {
                createNewSession();
                addLogEntry('Nouvelle session créée');
            });
            
            disconnectBtn.addEventListener('click', function() {
                if (activeSessionId && sessions.has(activeSessionId)) {
                    const session = sessions.get(activeSessionId);
                    addLogEntry(`[${session.username}] Déconnexion initiée`);
                    session.disconnect();
                }
            });
            
            pingBtn.addEventListener('click', function() {
                if (activeSessionId && sessions.has(activeSessionId)) {
                    const session = sessions.get(activeSessionId);
                    if (session.isConnected) {
                        addLogEntry(`[${session.username}] Envoi d'un ping manuel...`);
                        session.sendPing();
                    }
                }
            });
            
            // Gestion des onglets
            userTabs.addEventListener('click', function(e) {
                if (e.target.classList.contains('user-tab-close')) {
                    const sessionId = e.target.dataset.sessionId;
                    if (sessionId) {
                        removeSession(sessionId);
                    }
                    e.stopPropagation();
                }
            });
            
            // Gestion de la recherche
            searchBtn.addEventListener('click', function() {
                const query = searchInput.value.trim();
                searchUsers(query);
            });
            
            searchInput.addEventListener('input', function() {
                const query = searchInput.value.trim();
                searchUsers(query);
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = searchInput.value.trim();
                    searchUsers(query);
                }
            });
            
            // Fermer les résultats si on clique ailleurs
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container') && !e.target.closest('.search-results')) {
                    searchResults.style.display = 'none';
                }
            });
            
            // Modal
            modalClose.addEventListener('click', function() {
                userModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(e) {
                if (e.target === userModal) {
                    userModal.style.display = 'none';
                }
            });
            
            // Initialiser le moniteur
            addLogEntry('Moniteur de connexions multi-utilisateurs initialisé et prêt');
            
            // Ajout d'une vérification périodique des utilisateurs en ligne
            setInterval(() => {
                // Vérifier pour chaque session si elle est toujours considérée comme connectée
                sessions.forEach((session, sessionId) => {
                    if (session.isConnected) {
                        const isStillConnected = allOnlineUsers.some(user => user.id === session.userId);
                        if (!isStillConnected) {
                            session.updateConnectionState(false);
                        }
                    }
                });
            }, 10000); // Vérifier toutes les 10 secondes
        });
    </script>
</body>
</html>
